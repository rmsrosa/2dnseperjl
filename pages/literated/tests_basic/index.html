<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="" />
  <meta name="author" content="and contributors" />
   <title>Testing FFTW for fully periodic fluid flows</title>  
  <link rel="shortcut icon" type="image/png" href="/2dnsepervortjl/assets/images/favicon.png"/>
  <link rel="stylesheet" href="/2dnsepervortjl/css/base.css"/>
  
    <link rel="stylesheet" href="/2dnsepervortjl/css/base_showaside.css"/>
  
  <script src="/2dnsepervortjl/libs/mousetrap/mousetrap.min.js"></script>

  
    <link rel="stylesheet" href="/2dnsepervortjl/libs/highlight/github.min.css">
    <script src="/2dnsepervortjl/libs/highlight/highlight.pack.js"></script>
    <script src="/2dnsepervortjl/libs/highlight/julia.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre').forEach((el) => {
          hljs.highlightElement(el);
        });
      });
    </script>
  

  
    <link rel="stylesheet" href="/2dnsepervortjl/libs/katex/katex.min.css">
  
</head>

<body>

  <div class="books-container">

  <aside class="books-menu">
  <input type="checkbox" id="menu">
  <label for="menu">☰</label>

  <div class="books-title">
    <a href="/2dnsepervortjl/">Two-dimensional periodic flows</a>
  </div>

  <br />

  <div class="books-subtitle">
    Pseudo-spectral simulation in Julia
  </div>

  <br />

  <div class="books-author">
    <a href="https://rmsrosa.github.io">Ricardo M. S. Rosa</a>
  </div>

  <div class="books-menu-content">
    <div class="menu-level-1">
    <li><a href="/2dnsepervortjl/pages/intro">Introduction</a></li>
    </div>
    <div class="menu-level-1">
    <li>1. Mathematical Formulation</li>
    </div>
    <div class="menu-level-2">
    <li><a href="/2dnsepervortjl/pages/pressure-velocity">1.1. The pressure-velocity formulation</a></li>
    </div>
    <div class="menu-level-2">
    <li><a href="/2dnsepervortjl/pages/vorticity">1.2. Vorticity formulation</a></li>
    </div>
    <div class="menu-level-2">
    <li><a href="/2dnsepervortjl/pages/basdevant">1.3. Basdevant reduction</a></li>
    </div>
    <div class="menu-level-2">
    <li><a href="/2dnsepervortjl/pages/stream">1.4. Stream Function</a></li>
    </div>
    <div class="menu-level-1">
    <li>2. FFT Tools</li>
    </div>
    <div class="menu-level-2">
    <li><a href="/2dnsepervortjl/pages/literated/tests_basic">2.1. Testing FFTW for fully periodic fluid flows</a></li>
    </div>
<div>


  
    <a href="https://github.com/rmsrosa/2dnsepervortjl"><img src="/2dnsepervortjl/assets/images/GitHub-Mark-32px.png" alt="GitHub repo" width="18" style="margin:5px 5px" align="left"></a>

  

</aside>


  <div class="books-content">

    
      <div class="navbar">
    <p id="nav">
<span id="nav-prev" style="float: left;">
<a class="menu-level-1" href="/2dnsepervortjl/pages/stream">1.4. Stream Function <kbd>←</kbd></a>
</span>
    </p>
</div>
</br></br>

    

    
      <div class="badges">
<p>
<a href="https://nbviewer.org/urls/rmsrosa.github.io/2dnsepervortjl/generated/literated/tests_basic.ipynb"><img align="left" src="https://img.shields.io/badge/view%20in-nbviewer-orange" alt="View in NBViewer" title="View Jupyter notebook in NBViewer"></a>
<a href="https://mybinder.org/v2/gh/rmsrosa/2dnsepervortjl/binderenv?urlpath=git-pull%3Frepo%3Dhttps://github.com/rmsrosa/2dnsepervortjl%26urlpath%3Dlab/tree%252F2dnsepervortjl/generated/literated/tests_basic.ipynb%26branch%3Dgh-pages"><img align="left" src="https://mybinder.org/badge.svg" alt="Open in binder" title="Open in binder"></a>
<a href="/2dnsepervortjl/generated/literated/tests_basic.ipynb"><img align="left" src="https://img.shields.io/badge/download-notebook-blue" alt="Download notebook" title="Download Jupyter notebook"></a>
<a href="/2dnsepervortjl/src/literate/tests_basic.jl"><img align="left" src="https://img.shields.io/badge/view-source-lightblue" alt="View source" title="View source"></a>
</p>
</div></br>

    
<h1 id="get_title"><a href="#get_title" class="header-anchor">2.1. Testing FFTW for fully periodic fluid flows</a></h1>
<p>Here we test the methods, in FFTW, to be used in the pseudo-spectral code described previously.</p>
<p>We start by loading the packages we need:</p>
<pre><code class="language-julia">using FFTW
using CairoMakie
using Test</code></pre>
<h2 id="the_spatial_domain_and_its_spatial_discretization"><a href="#the_spatial_domain_and_its_spatial_discretization" class="header-anchor">The spatial domain and its spatial discretization</a></h2>
<p>We consider a square domain of sides \(L = 2\pi\), for which the smallest wavenumber is \(\kappa_0 = 2\pi/L\).</p>
<pre><code class="language-julia">L &#61; 2π
κ₀ &#61; 2π/L</code></pre>
<pre><code class="language-julia">1.0</code></pre>
<p>We set the number \(N\) of points for the mesh in each direction, yielding a mesh \((x_i, y_j)_{i, j = 1,\ldots ,N}\), with \(x_N = y_N = L\), and steps \(x_{i+1} - x_i = L/N\), and \(y_{j+1} - y_j = L/N\). Due to the periodicity, we don&#39;t need to store the values corresponding to \(i = j = 0\).</p>
<pre><code class="language-julia">N &#61; 128
x &#61; y &#61; &#40;L/N&#41;:&#40;L/N&#41;:L
nothing</code></pre>
<p>We may visualize the grid with a scatter plot, although if the mesh is too thin, we won&#39;t quite see the details. But if using GLMakie or WGLMakie, one can zoom in for a detailed view.</p>
<pre><code class="language-julia">fig, ax, plt &#61; scatter&#40;vec&#40;x .* one.&#40;y&#41;&#39;&#41;, vec&#40;one.&#40;x&#41; .* y&#39;&#41;&#41;

fig</code></pre>
<img src="/2dnsepervortjl/assets/pages/literated/tests_basic/code/1209811589.png" alt="">
<h2 id="a_vorticity_function_for_testing"><a href="#a_vorticity_function_for_testing" class="header-anchor">A vorticity function for testing</a></h2>
<p>In order to test the methods from <a href="http://www.fftw.org">FFTW.jl</a>, we define a certain vorticity function and its derivatives</p>
<pre><code class="language-julia">vort &#61; sin.&#40;one.&#40;y&#41; * x&#39;&#41; .* cos.&#40;3y * one.&#40;x&#41;&#39;&#41;
dx_vort &#61; cos.&#40;one.&#40;y&#41; * x&#39;&#41; .* cos.&#40;3y * one.&#40;x&#41;&#39;&#41;
dy_vort &#61; - 3 * sin.&#40;one.&#40;y&#41; * x&#39;&#41; .* sin.&#40;3y * one.&#40;x&#41;&#39;&#41;
dd_vort &#61; - sin.&#40;one.&#40;y&#41; * x&#39;&#41; .* cos.&#40;3y * one.&#40;x&#41;&#39;&#41; - 9 * sin.&#40;one.&#40;y&#41; * x&#39;&#41; .* cos.&#40;3y * one.&#40;x&#41;&#39;&#41;

nothing</code></pre>
<p>We may visualize the vorticity as a surface:</p>
<pre><code class="language-julia">fig &#61; Figure&#40;backgroundcolor &#61; RGBf&#40;0.98, 0.98, 0.98&#41;&#41;

ax &#61; Axis3&#40;fig&#91;1, 1&#93;, xlabel &#61; &quot;x&quot;, ylabel &#61; &quot;y&quot;, zlabel &#61; &quot;vorticity level&quot;, title &#61; &quot;Vorticity graph&quot;&#41;

surface&#33;&#40;ax, x, y, vort, colormap &#61; :berlin&#41;

fig</code></pre>
<img src="/2dnsepervortjl/assets/pages/literated/tests_basic/code/1413433971.png" alt="">
<p>Or, better yet, as a heatmap:</p>
<pre><code class="language-julia">fig, ax, plt &#61; heatmap&#40;x, y, vort, colormap &#61; :berlin&#41;

ax &#61; Axis&#40;fig&#91;1, 1&#93;, xlabel &#61; &quot;x&quot;, ylabel &#61; &quot;y&quot;, title &#61; &quot;Vorticity heatmap&quot;&#41;

fig</code></pre>
<img src="/2dnsepervortjl/assets/pages/literated/tests_basic/code/795613348.png" alt="">
<h2 id="testing_the_direct_and_inverse_discrete_fourier_transform"><a href="#testing_the_direct_and_inverse_discrete_fourier_transform" class="header-anchor">Testing the direct and inverse discrete Fourier transform</a></h2>
<p>We check going back and forth with the real fft and inverse real fft:</p>
<pre><code class="language-julia">@testset &quot;check composition &#96;irfft ∘ rfft&#96;&quot; begin
    vort_hat &#61; rfft&#40;vort&#41;
    vortback &#61; irfft&#40;vort_hat, N&#41;
    @test vort ≈ vortback
end
nothing</code></pre>
<pre><code class="language-julia">Test Summary:                    | Pass  Total
check composition &#96;irfft ∘ rfft&#96; |    1      1</code></pre>
<h2 id="differential_operators"><a href="#differential_operators" class="header-anchor">Differential operators</a></h2>
<p>In order to check the derivatives in spectral space, we define the following operators. Actually, they are just vectors, since derivatives in spectral space act as diagonal operators.</p>
<pre><code class="language-julia">Dx_hat &#61; im * κ₀ * &#91;ifelse&#40;k1 ≤ N/2 &#43; 1, k1 - 1, k1 - 1 - N&#41; for k2 in 1:N/2&#43;1, k1 in 1:N&#93;
Dy_hat &#61; im * κ₀ * &#91;k2 - 1 for k2 in 1:N/2&#43;1, k1 in 1:N&#93;

Delta_hat &#61; - κ₀^2 * &#91;
    ifelse&#40;k1 ≤ N/2 &#43; 1, &#40;k1 - 1&#41;^2 &#43; &#40;k2 - 1&#41;^2, &#40;k1 - 1 - N&#41;^2 &#43; &#40;k2 - 1&#41;^2&#41;
    for k2 in 1:N/2&#43;1, k1 in 1:N
&#93;

Hu_hat &#61; - Dy_hat ./ Delta_hat
Hu_hat&#91;1, 1&#93; &#61; 0.0
Hv_hat &#61; Dx_hat ./ Delta_hat
Hv_hat&#91;1, 1&#93; &#61; 0.0

nothing</code></pre>
<h2 id="testing_the_spectral_operators"><a href="#testing_the_spectral_operators" class="header-anchor">Testing the spectral operators</a></h2>
<p>Now we are ready to test the differentiation in spectral space, with the operators just defined.</p>
<pre><code class="language-julia">@testset &quot;Check operators&quot; begin
    vort_hat &#61; rfft&#40;vort&#41;
    u_hat &#61; Hu_hat .* vort_hat
    v_hat &#61; Hv_hat .* vort_hat
    # check derivative dx in spectral space:
    @test irfft&#40;Dx_hat .* vort_hat, N&#41; ≈ dx_vort
    # check derivative dy in spectral space:
    @test irfft&#40;Dy_hat .* vort_hat, N&#41; ≈ dy_vort
    # check Laplacian in spectral space:
    @test Delta_hat ≈ Dx_hat.^2 .&#43; Dy_hat.^2
    @test irfft&#40;Delta_hat .* vort_hat, N&#41; ≈ dd_vort
    # check recovering velocity field from vorticity
    @test Dx_hat .* v_hat - Dy_hat .* u_hat ≈ vort_hat
end
nothing</code></pre>
<pre><code class="language-julia">Test Summary:   | Pass  Total
Check operators |    5      5</code></pre>
<h2 id="one-mode_steady_state"><a href="#one-mode_steady_state" class="header-anchor">One-mode steady state</a></h2>
<p>For forced-periodic flows, when the forcing function contains a single Fourier mode, there is a corresponding steady state vorticity function corresponding also to a single-mode in Fourier space, which is the same as that for the forcing. Only the energy is different.</p>
<p>In order to construct such pairs of forcing mode / steady state, we set define the viscosity of the flow, choose the mode to be forced and define the strength of that force:</p>
<pre><code class="language-julia">ν &#61; 1.0e-0 # viscosity
κ &#61; &#40;x &#61; 1, y &#61; 2&#41; # forced mode
α &#61; &#40;re &#61; 0.1, im &#61; 0.05&#41; # strength

nothing</code></pre>
<p>With these parameters, we find the curl <code>g_steady</code> of the forcing term and the vorticity <code>vort_steady</code> of the corresponding steady-state:</p>
<pre><code class="language-julia">g_steady &#61; ν * &#40;
    2α.re * κ₀^4 * sum&#40;abs2, κ&#41;^2 * cos.&#40;κ₀ * &#40;κ.x * one.&#40;y&#41; * x&#39; &#43; κ.y * y * one.&#40;x&#41;&#39;&#41;&#41;
    - 2α.im * κ₀^4 * sum&#40;abs2, κ&#41;^2 * sin.&#40;κ₀ * &#40;κ.x * one.&#40;y&#41; * x&#39; &#43; κ.y * y * one.&#40;x&#41;&#39;&#41;&#41;
&#41;

vort_steady &#61; 2κ₀^2 * sum&#40;abs2, κ&#41; * &#40;
    α.re * cos.&#40;κ₀ * &#40;κ.x * one.&#40;y&#41; * x&#39; &#43; κ.y * y * one.&#40;x&#41;&#39;&#41;&#41;
    - α.im * sin.&#40;κ₀ * &#40;κ.x * one.&#40;y&#41; * x&#39; &#43; κ.y * y * one.&#40;x&#41;&#39;&#41;&#41;
&#41;
nothing</code></pre>
<p>Here are some visualizations of the curl of the forcing term and of the vorticity</p>
<pre><code class="language-julia">heatmap&#40;x, y, g_steady, xlabel&#61;&quot;x&quot;, ylabel&#61;&quot;y&quot;, title&#61;&quot;Curl of the forcing term&quot;, titlefont&#61;12&#41;

heatmap&#40;x, y, vort_steady, xlabel&#61;&quot;x&quot;, ylabel&#61;&quot;y&quot;, title&#61;&quot;Steady state vorticity&quot;, titlefont&#61;12&#41;

nothing</code></pre>
<p>The discrete Fourier transform of this vector fields are given as</p>
<pre><code class="language-julia">g_steady_hat &#61; rfft&#40;g_steady&#41;

vort_steady_hat &#61; rfft&#40;vort_steady&#41;

nothing</code></pre>
<h2 id="testing_the_steady_state"><a href="#testing_the_steady_state" class="header-anchor">Testing the steady state</a></h2>
<p>We are now ready to test the steadyness of this vorticity field:</p>
<pre><code class="language-julia">@testset &quot;Check single-mode stable steady state&quot; begin
    u_steady_hat &#61; Hu_hat .* vort_steady_hat
    v_steady_hat &#61; Hv_hat .* vort_steady_hat

    u_steady &#61; irfft&#40;u_steady_hat, N&#41;
    v_steady &#61; irfft&#40;v_steady_hat, N&#41;

    vort_steady_back &#61; irfft&#40;vort_steady_hat, N&#41;

    wu_steady_hat &#61; rfft&#40;vort_steady_back .* u_steady&#41;
    wv_steady_hat &#61; rfft&#40;vort_steady_back .* v_steady&#41;

    rhs_steady &#61; g_steady_hat .&#43; Delta_hat .* vort_steady_hat .- Dx_hat .* wu_steady_hat .- Dy_hat .* wv_steady_hat

    vort_steady_sol_hat &#61; - g_steady_hat ./ Delta_hat
    vort_steady_sol_hat&#91;1, 1&#93; &#61; 0.0im
    # Vanishing bilinear term on one-mode steady state
    @test maximum&#40;abs.&#40;Dx_hat .* wu_steady_hat .&#43; Dy_hat .* wv_steady_hat&#41;&#41; ≤ √eps&#40;&#41;
    # Vanishing RHS on steady state
    @test maximum&#40;abs.&#40;rhs_steady&#41;&#41; ≤ √eps&#40;&#41;
    # Vanishing linear Stokes on steady state
    @test maximum&#40;abs.&#40;g_steady_hat .&#43; Delta_hat .* vort_steady_hat&#41;&#41; ≤ √eps&#40;&#41;

    # Steady state equation
    @test g_steady_hat ≈ - Delta_hat .* vort_steady_hat ≈ - Delta_hat .* vort_steady_hat .- Dx_hat .* wu_steady_hat .- Dy_hat .* wv_steady_hat

    # Steady state solution
    @test vort_steady_sol_hat ≈ vort_steady_hat
end
nothing</code></pre>
<pre><code class="language-julia">Test Summary:                         | Pass  Total
Check single-mode stable steady state |    5      5</code></pre>

    <div class="navbar">
    <p id="nav">
<span id="nav-prev" style="float: left;">
<a class="menu-level-1" href="/2dnsepervortjl/pages/stream">1.4. Stream Function <kbd>←</kbd></a>
</span>
    </p>
</div>
</br></br>



<div class="page-foot">
    
        <div class="license">
            <a href=LICENSE>MIT License </a>
            <a href="https://rmsrosa.github.io">(Ricardo M. S. Rosa)</a>
        </div>
    

    Last modified: March 16, 2022. Built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>, using the <a href="https://github.com/rmsrosa/booksjl-franklin-template">Book Template</a>.
</div><!-- CONTENT ENDS HERE -->

      </div> <!-- .books-content -->
    </div> <!-- .books-container -->

    
        <script src="/2dnsepervortjl/libs/katex/katex.min.js"></script>
        <script src="/2dnsepervortjl/libs/katex/auto-render.min.js"></script>
        <script>renderMathInElement(document.body)</script>
    

    
        <script src="/2dnsepervortjl/libs/highlight/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>
    

  </body>
</html>
